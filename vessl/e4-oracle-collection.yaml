# VESSL Job Spec — E4: Oracle Trajectory Collection (SFT corpus)
# Purpose : Run best agent on TRAIN split to collect successful trajectories
#           as LoRA SFT training data.
# Gate    : Only launch after E2 confirms best agent SR >= 20% on OOD split.
# Runtime : ~12–18 h on RTX 3090 (2000 games); shardable to ~4–6 h (3 jobs)
# Run with: vessl run create -f vessl/e4-oracle-collection.yaml
#
# SHARDING: launch 3 parallel jobs overriding SHARD_START + SHARD_END:
#   vessl run create -f vessl/e4-oracle-collection.yaml
#   (edit env vars SHARD_START/SHARD_END per job, or use VESSL UI overrides)
#   Job A: SHARD_START=0,    SHARD_END=667
#   Job B: SHARD_START=667,  SHARD_END=1334
#   Job C: SHARD_START=1334, SHARD_END=2000
#   Merge: python scripts/merge_shards.py \
#            --inputs results/e4_*_raw.json --output results/e4_raw_results.json

name: alfworld-e4-oracle-collection

resources:
  cluster: yonsei-ai-gpu
  preset: gpu-1

image: quay.io/vessl-ai/torch:2.3.1-cuda12.1-r5

env:
  OLLAMA_URL:       "http://localhost:11434"
  ALFWORLD_DATA:    "/data/alfworld"
  MODEL_NAME:       "llama3.1:8b"
  NUM_GAMES:        "2000"
  PYTHONUNBUFFERED: "1"
  # Override per shard job:
  # SHARD_START: "0"
  # SHARD_END:   "667"

run:
  - command: |
      set -e

      pip install --quiet vessl alfworld textworld rich

      python3 -c "import vessl.storage, os; os.makedirs('/tmp/scripts', exist_ok=True); vessl.storage.download_volume_file('vessl-storage', 'alfworld-scripts', '/tmp/scripts/')"

      mkdir -p /app
      cd /tmp/scripts
      if ls *.zip 1>/dev/null 2>&1; then unzip -o *.zip -d /app/; else cp -r . /app/; fi

      python3 -c "import vessl.storage, os; os.makedirs('/data/alfworld', exist_ok=True); vessl.storage.download_volume_file('vessl-storage', 'alfworld-data', '/data/alfworld/')"

      curl -fsSL https://ollama.com/install.sh | sh
      ollama serve &
      sleep 10
      ollama pull llama3.1:8b

      cd /app
      SHARD_START=${SHARD_START:-0}
      SHARD_END=${SHARD_END:-$NUM_GAMES}
      GAME_COUNT=$((SHARD_END - SHARD_START))
      SUFFIX="${SHARD_START}_${SHARD_END}"

      CHECKPOINT="/app/results/e4_${SUFFIX}_checkpoint.json"
      OUTPUT_RAW="/app/results/e4_${SUFFIX}_raw.json"
      OUTPUT_ORACLE="/app/results/oracle/trajectories_${SUFFIX}.jsonl"
      mkdir -p /app/results/oracle

      # Update --agents after E2 results (use winning agent)
      python scripts/run_baseline.py \
        --agents reflexion hierarchical \
        --num-games "$GAME_COUNT" \
        --max-steps 50 \
        --split train \
        --checkpoint "$CHECKPOINT" \
        --output    "$OUTPUT_RAW"

      python scripts/filter_oracle_trajectories.py \
        --input  "$OUTPUT_RAW" \
        --output "$OUTPUT_ORACLE" \
        --agents reflexion hierarchical \
        --min-steps 3

      python3 -c "import vessl.storage; vessl.storage.upload_volume_file('/app/results/', 'vessl-storage', 'alfworld-results')"

      echo "=== E4 complete: $(wc -l < $OUTPUT_ORACLE) trajectories written ==="
